import streamlit as st
import gspread
import pandas as pd
import json
from google.oauth2.service_account import Credentials

# ===== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets =====
SCOPE = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds_dict = json.loads(st.secrets["GOOGLE_SHEETS_CREDENTIALS"])
creds = Credentials.from_service_account_info(creds_dict, scopes=SCOPE)
client = gspread.authorize(creds)

# ===== Ø¥Ø¹Ø¯Ø§Ø¯ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
st.set_page_config(page_title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", page_icon="ğŸ”")
st.title("ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")

# ===== Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠØ¯ÙˆÙŠ =====
if st.button("ğŸ”„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"):
    st.cache_data.clear()
    st.success("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")

# Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ ÙˆÙ‡Ù…ÙŠØ© Ù…Ø®ÙÙŠØ© Ù„Ù…Ù†Ø¹ ØªØ¹Ø¨Ø¦Ø© iCloud Keychain Ø¹Ù„Ù‰ iOS
st.markdown(
    """
    <input type="text" name="fake_username" style="opacity:0; position:absolute; top:-1000px;">
    <input type="password" name="fake_password" style="opacity:0; position:absolute; top:-1000px;">
    """,
    unsafe_allow_html=True
)

# ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
if "authenticated" not in st.session_state:
    st.session_state["authenticated"] = False

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
if not st.session_state["authenticated"]:
    with st.form("login_form"):
        username = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        password = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password")
        submitted = st.form_submit_button("Ø¯Ø®ÙˆÙ„")

        if submitted:
            # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø´ÙŠØª Ø§Ù„Ø£Ø¯Ù…Ù†
            admin_sheet = client.open_by_key("1gOmeFwHnRZGotaUHqVvlbMtVVt1A2L7XeIuolIyJjAY").worksheet("admin")
            users_df = pd.DataFrame(admin_sheet.get_all_records())
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            matched = users_df[
                (users_df["username"] == username) &
                (users_df["password"] == password)
            ]
            if not matched.empty:
                user_row = matched.iloc[0]
                full_name = user_row["full_name"]  # Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„
                st.session_state["authenticated"] = True
                st.session_state["username"] = username  # Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù€ username Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                st.session_state["full_name"] = full_name  # ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©
                st.session_state["sheet_url"] = user_row["sheet_name"]
                st.session_state["permissions"] = user_row["role"]
                st.success("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")

                # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                if st.session_state["permissions"] in ["supervisor", "sp"]:
                    st.switch_page("pages/Supervisor.py")
                elif st.session_state["permissions"] == "admin":
                    st.switch_page("pages/AdminDashboard.py")
                elif st.session_state["permissions"] == "user":
                    st.switch_page("pages/UserDashboard.py")
                else:
                    st.error("âš ï¸ ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©.")
            else:
                st.error("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©")
else:
    # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
    permission = st.session_state.get("permissions")
    if permission in ["supervisor", "sp"]:
        st.switch_page("pages/Supervisor.py")
    elif permission == "admin":
        st.switch_page("pages/AdminDashboard.py")
    elif permission == "user":
        st.switch_page("pages/UserDashboard.py")
    else:
        st.error("âš ï¸ ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©.")
